# AI 原油价格预测项目 (Citi-Plus)简单构想：

1.总体是两个东西：后端+前端，后端是个AI模型，前端是个网页，网页实在不行让AI写一写，我也学一学
2.模型的输入数据是各种油价的影响因素+前若干天的油价+一个新闻影响因素
3.训练的时候直接从官方接口里获取各种数据，利用 VIX (恐慌指数) + 价格动向 算出一个当时的新闻对于油价的影响
4.模型的输出有三个：
    （1）预测出的下一天的油价（一个区间）
    （2）预测油价的置信度（
    （3）用SHAP去黑盒化，体现出每个因素对油价影响的占比
5.推理的时候准备用爬虫去网上爬一下新闻数据，可以只把新闻的标题取下来，用一个LLM比如DeepSeek的API，生成每条有关的新闻对油价的影响，负面冲击还是正面冲击（-1~1），传给模型


使用深度学习模型 (**Attention-BiGRU**: 带注意力机制的双向GRU) 来预测 WTI 原油每日收盘价格。项目包含完整的数据加载、特征工程、模型训练、验证和可视化流程。

当前情况：已经训练了一次，模型收敛太快，置信度很低，准备尝试优化模型/进一步减小BATCH_SIZE，三张图片即为当前/models里的模型的测试结果。

## 目录结构

*   `README_ENV.md`: 配置所需的运行环境的详细教程（使用conda）
*   `config.py`: 项目的全局配置文件，包含所有参数设置。
*   `data_loader.py`: 负责数据的读取、清洗、API下载（如 Yahoo Finance）、技术指标计算等特征工程。
*   `train.py`: 训练脚本，定义了模型训练循环、损失函数和早停机制。
*   `main.py`: 推理与分析脚本，用于加载训练好的模型，在测试集上进行预测，并生成详细的分析图表。
*   `model.py`: 定义神经网络结构 (`AttentionBiGRU`)。
*   `utils.py`: 通用工具函数（如设备检测、随机种子设置）。
*   `input_data/`: 存放本地 CSV 数据的文件夹。
*   `models/`: 存放训练好的模型权重 (`.pth`) 和归一化器 (`.pkl`)。
*   `data/`: 存放处理后的缓存数据。

## 使用方法

### 1. 准备数据

您可以将历史数据 CSV 文件放入 `input_data` 文件夹（文件名如 `CL=F.csv`）。如果没有本地文件，程序会自动尝试从 Yahoo Finance 下载。

### 2. 训练模型

运行以下命令开始训练：
================================================================================================================================
python train.py
================================================================================================================================
训练过程会自动保存验证集 Loss 最低的模型到 `models/best_oil_price_model.pth`。

### 3.预测与分析

训练完成后，运行以下命令生成预测图表：
================================================================================================================================
python main.py
================================================================================================================================
这将生成以下图片：
*   `oil_price_prediction_full.png`: 仅展示**测试集**（未知数据）的预测结果，包含置信区间和置信度评分。
*   `prediction_analysis.png`: 最近200天的详细回测图。
*   `model_validation_comparison.png`: 训练集拟合情况与测试集泛化能力的对比。
*   `feature_importance.png`: 必须特征的重要性排行。

## 参数详解 (config.py)

您可以在 `config.py` 中修改以下重要参数来调整模型行为。

### 数据相关 (`Data Related`)
*   `START_DATE / END_DATE`: 设定训练和回测数据的时间范围（例如 `"2000-01-01"`）。
*   `TICKER_OIL`: 目标预测资产的代码（默认为 `CL=F` 即 WTI 原油）。
*   `REMOVE_EXTREME_OUTLIERS`: **极端值处理开关**。
    *   `True`: 将负油价（如2020年4月的-40美元）视为数据缺失并用前值填充。**推荐开启**，能让模型学习正常市场规律。
    *   `False`: 保留负油价。仅用于压力测试，可能导致模型不稳定。

### 特征与模型 (`Feature & Model`)
*   `SEQ_LENGTH (60)`: **序列长度**。模型每次“回头看”过去多少天的数据来做预测。
*   `HIDDEN_DIM (128)`: **隐藏层维度**。神经网络的容量，越大能拟合越复杂的模式，但也越容易过拟合。
*   `NUM_LAYERS (2)`: GRU 的堆叠层数。
*   `DROPOUT (0.4)`: **随机失活率**。在训练时随机丢弃 40% 的神经元连接，是防止“死记硬背”（过拟合）的关键参数。

### 训练参数 (`Training`)
*   `BATCH_SIZE (32)`: **批次大小**。每次参数更新使用的数据样本数。较小的 Batch Size (32) 能引入更多随机噪声，有助于模型跳出局部最优解，提高泛化能力。
*   `EPOCHS (100)`: 最大训练轮数。
*   `LEARNING_RATE (0.0001)`: **学习率**。控制模型参数更新的步幅。较小的值（0.0001）能让模型收敛得更平滑、更精准，但速度较慢。
*   `PATIENCE (15)`: **早停耐心值**。如果模型在验证集上的表现连续 15 轮没有提升，则提前终止训练。

## 常见问题处理

1.  **出现 `running without feature names` 警告**
    *   这通常是由于 `sklearn` 版本差异导致的，已在代码中通过将 numpy 数组转换为 DataFrame 修复。

2.  **训练收敛太快 / 泛化能力差**
    *   尝试**减小** `LEARNING_RATE`（如从 0.001 改为 0.0001）。
    *   尝试**增大** `DROPOUT`（如 0.3 -> 0.4）。
    *   检查数据量是否太少（建议至少 3000 行以上数据）。
